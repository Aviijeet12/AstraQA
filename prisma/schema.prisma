generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Connection URL is configured via prisma.config.ts / PrismaClient
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  files     File[]
  testCases TestCase[]
  scripts   Script[]
  settings  Settings?
}

model File {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  name        String
  mimeType    String
  sizeBytes   Int
  supabaseKey String   // path/key inside Supabase bucket
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  chunks Chunk[]
}

model Chunk {
  id        String   @id @default(cuid())
  file      File     @relation(fields: [fileId], references: [id])
  fileId    String
  index     Int
  content   String
  embedding Bytes?    // optional; primary embeddings live in Chroma
  createdAt DateTime @default(now())
}

model TestCase {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id])
  userId        String
  externalId    String   // e.g. "TC-001"
  feature       String
  scenario      String
  steps         String   // JSON string array
  expectedResult String
  type          String   // "positive" | "negative"
  createdAt     DateTime @default(now())

  scripts Script[]
}

model Script {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  testCase   TestCase @relation(fields: [testCaseId], references: [id])
  testCaseId String
  title      String
  language   String   // e.g. "python-selenium"
  content    String   // full script source
  createdAt  DateTime @default(now())
}

model Settings {
  id                String   @id @default(cuid())
  user              User     @relation(fields: [userId], references: [id])
  userId            String   @unique
  browserPreference String?  // e.g. "chrome", "firefox"
  timeoutSeconds    Int?     // default wait timeout
  theme             String?  // "light" | "dark" | etc.
  llmProvider       String?  // e.g. "gemini-1.5-flash"
  vectorDbProvider  String?  // e.g. "chroma-local"
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model KnowledgeBaseStatus {
  id             String   @id @default(cuid())
  user           User     @relation(fields: [userId], references: [id])
  userId         String   @unique
  status         String   // "empty" | "building" | "ready" | "error"
  lastBuildAt    DateTime?
  lastError      String?
  filesIndexed   Int      @default(0)
  chunksIndexed  Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
